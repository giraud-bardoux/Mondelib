<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Publier une soir√©e sur Mondelibertin</title>
  <style>
    body{font-family:Arial, sans-serif;max-width:900px;margin:40px auto;padding:0 15px;line-height:1.5}
    h1{color:#d23d7a}
    label{display:block;margin-top:12px}
    input[type=text],textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px}
    button{margin-top:20px;padding:10px 18px;background:#d23d7a;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin-top:25px;padding:12px;border-radius:4px}
    .status.ok{background:#e3f7e7;color:#23703d}
    .status.err{background:#fde2e2;color:#a33a3a}
    pre{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Importateur de soir√©e ‚Üí Mondelibertin</h1>
  <p>Cette page vous permet d'importer automatiquement les informations d'une soir√©e pr√©sente sur un site partenaire, puis de publier l'√©v√®nement sur <strong>mondelibertin.com</strong>. Vous devez √™tre pr√©alablement connect√©&nbsp;√† Mondelibertin dans ce navigateur.</p>

  <label for="eventUrl">URL de la page de la soir√©e (site partenaire)</label>
  <input type="text" id="eventUrl" placeholder="https://partner-site.com/evenements/ma-soiree"/>
  <button id="btnParse">1Ô∏è‚É£&nbsp;Analyser la page partenaire</button>
  
  <div style="margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
    <strong>üîß Probl√®me CORS ?</strong>
    <button id="btnManual" style="margin-left: 10px; font-size: 14px; padding: 5px 10px;">Import manuel</button>
  </div>
  
  <div id="manualImport" style="display:none; margin-top: 15px;">
    <h3>Import manuel</h3>
    <p>Si l'analyse automatique ne fonctionne pas, copiez-collez le code HTML de la page :</p>
    <textarea id="manualHtml" rows="8" placeholder="Collez ici le code HTML de la page..."></textarea>
    <button id="btnParseManual">Analyser le HTML coll√©</button>
  </div>

  <div id="preview" style="display:none">
    <h2>Aper√ßu des donn√©es extraites</h2>
    <pre id="previewData"></pre>
    <button id="btnPublish">2Ô∏è‚É£&nbsp;Publier sur Mondelibertin</button>
  </div>

  <div id="result" class="status" style="display:none"></div>

<script>
/* =====================
 * PARSERS PAR SITE
 * Ajoutez ici une fonction de parsing par nom de domaine
 * Chaque fonction re√ßoit le document HTML et doit renvoyer un objet :
 * {title, description, startDate, endDate, location, imageUrl, category}
 * ===================== */
function parsePartnerSite(url, doc){
  const hostname = new URL(url).hostname;
  if(hostname.includes('partner-site.com')){
    return parsePartnerSiteExample(doc);
  }
  if(hostname.includes('wemagnifique.fr')){
    return parseWemagnifique(doc);
  }
  throw new Error('Aucun parseur disponible pour ce domaine ('+hostname+').');
}

function parsePartnerSiteExample(doc){
  /* Exemple de parseur pour https://partner-site.com */
  const title = doc.querySelector('h1.event-title')?.textContent.trim();
  const description = doc.querySelector('.event-description')?.innerText.trim();
  const dateString = doc.querySelector('.event-date')?.textContent.trim();
  const [startDate, endDate] = dateString?.split('‚Äì').map(s=>s.trim()) || [];
  const location = doc.querySelector('.event-location')?.textContent.trim();
  const imageUrl = doc.querySelector('.event-cover img')?.src;
  const category = doc.querySelector('.event-category')?.textContent.trim();
  return {title, description, startDate, endDate, location, imageUrl, category};
}

function parseWemagnifique(doc){
  /* Parseur pour https://wemagnifique.fr */
  
  // Titre de l'√©v√©nement
  const title = doc.querySelector('h1, .page-title, .event-title, .entry-title')?.textContent?.trim() || 
                doc.querySelector('title')?.textContent?.replace('WeMagnifique', '').trim();
  
  // Description - chercher dans plusieurs s√©lecteurs possibles
  const description = doc.querySelector('.event-description, .entry-content, .post-content, .content, .description')?.innerText?.trim() ||
                     doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
                     doc.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
                     '';
  
  // Date - format flexible pour diff√©rents formats de dates
  let startDate = '';
  let endDate = '';
  
  // Chercher les dates dans diff√©rents formats
  const dateElements = [
    doc.querySelector('.event-date, .date, .event-time, .time'),
    doc.querySelector('[class*="date"]'),
    doc.querySelector('[class*="time"]')
  ].filter(el => el);
  
  if (dateElements.length > 0) {
    const dateText = dateElements[0].textContent.trim();
    // G√©rer diff√©rents formats de dates
    if (dateText.includes('‚Äì') || dateText.includes('-')) {
      const dates = dateText.split(/[‚Äì-]/).map(s => s.trim());
      startDate = dates[0];
      endDate = dates[1] || dates[0];
    } else {
      startDate = dateText;
      endDate = dateText;
    }
  }
  
  // Si pas de date trouv√©e, chercher dans le titre ou URL
  if (!startDate && title.toLowerCase().includes('mardi')) {
    startDate = 'Tous les mardis';
  }
  
  // Localisation
  const location = doc.querySelector('.event-location, .location, .venue, .address')?.textContent?.trim() ||
                  (title.includes('Paris') ? 'Paris' : '') ||
                  '';
  
  // Image
  let imageUrl = '';
  const imgElement = doc.querySelector('.event-image img, .featured-image img, .post-image img, img[class*="event"], img[class*="featured"]') ||
                    doc.querySelector('meta[property="og:image"]') ||
                    doc.querySelector('meta[name="twitter:image"]');
  
  if (imgElement) {
    if (imgElement.tagName === 'IMG') {
      imageUrl = imgElement.src;
    } else {
      imageUrl = imgElement.getAttribute('content');
    }
    
    // Convertir URL relative en URL absolue si n√©cessaire
    if (imageUrl && !imageUrl.startsWith('http')) {
      imageUrl = new URL(imageUrl, 'https://wemagnifique.fr').href;
    }
  }
  
  // Cat√©gorie
  const category = doc.querySelector('.category, .event-category, .tag')?.textContent?.trim() ||
                  'Soir√©e libertine' || // cat√©gorie par d√©faut pour ce site
                  '';
  
  return {
    title: title || 'Soir√©e WeMagnifique',
    description: description,
    startDate: startDate,
    endDate: endDate,
    location: location,
    imageUrl: imageUrl,
    category: category
  };
}

/* =====================
 * Helper: GET HTML document via fetch avec fallbacks CORS
 * ===================== */
async function fetchDocument(url){
  const methods = [
    // M√©thode 1: Fetch direct (fonctionne si CORS est d√©sactiv√© via extension)
    () => fetch(url, {
      mode: 'cors',
      credentials: 'omit',
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; Mondelibertin-Importer/1.0)'
      }
    }).then(r => r.text()),
    
    // M√©thode 2: Proxy public AllOrigins
    () => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`)
      .then(r => r.text()),
    
    // M√©thode 3: Proxy local PHP (si disponible)
    () => fetch(`proxy.php?url=${encodeURIComponent(url)}`, {credentials:'include'})
      .then(r => r.json())
      .then(data => {
        if (!data.success) throw new Error(data.error);
        return data.html;
      }),
    
    // M√©thode 4: Autre proxy public
    () => fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`)
      .then(r => r.text())
  ];
  
  let lastError;
  for (let i = 0; i < methods.length; i++) {
    try {
      console.log(`üîÑ Tentative ${i + 1}/${methods.length} pour r√©cup√©rer: ${url}`);
      const html = await methods[i]();
      console.log(`‚úÖ Succ√®s avec la m√©thode ${i + 1}`);
      return new DOMParser().parseFromString(html, 'text/html');
    } catch (error) {
      console.warn(`‚ùå M√©thode ${i + 1} √©chou√©e:`, error.message);
      lastError = error;
    }
  }
  
  // Si toutes les m√©thodes √©chouent, afficher les instructions CORS
  const corsInstructions = `
‚ùå Impossible de r√©cup√©rer la page. Erreur CORS d√©tect√©e.

üîß SOLUTIONS DISPONIBLES:

1Ô∏è‚É£ **Extension CORS (Recommand√©)**:
   - Installez "CORS Unblock" ou "CORS Everywhere" 
   - Activez l'extension temporairement
   - Rechargez cette page et relancez l'importation

2Ô∏è‚É£ **Chrome avec s√©curit√© d√©sactiv√©e**:
   - Fermez Chrome compl√®tement
   - Red√©marrez avec: --disable-web-security --user-data-dir=/tmp/chrome-dev

3Ô∏è‚É£ **Serveur local PHP**:
   - Configurez un serveur web local avec le fichier proxy.php

4Ô∏è‚É£ **Import manuel**:
   - Copiez le contenu de la page source
   - Utilisez l'option d'import manuel (si disponible)

Derni√®re erreur: ${lastError?.message || 'Inconnue'}`;

  throw new Error(corsInstructions);
}

/* =====================
 * √âtape 1: Parse partenaire
 * ===================== */
async function parsePartnerPage(){
  hideStatus();
  const url = document.getElementById('eventUrl').value.trim();
  if(!url){showError('Veuillez saisir une URL.');return;}
  setLoading(true);
  try{
    const doc = await fetchDocument(url);
    const data = parsePartnerSite(url, doc);
    // Stocker pour √©tape 2
    window.__eventData = {...data, sourceUrl:url};
    document.getElementById('previewData').textContent = JSON.stringify(window.__eventData, null, 2);
    document.getElementById('preview').style.display = 'block';
    showOk('Analyse termin√©e. V√©rifiez les donn√©es puis cliquez sur Publier.');
  }catch(err){
    showError(err.message);
  }finally{
    setLoading(false);
  }
}

/* =====================
 * Import manuel
 * ===================== */
function parseManualHtml(){
  hideStatus();
  const url = document.getElementById('eventUrl').value.trim();
  const html = document.getElementById('manualHtml').value.trim();
  
  if(!url){showError('Veuillez saisir une URL.');return;}
  if(!html){showError('Veuillez coller le code HTML.');return;}
  
  setLoading(true);
  try{
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const data = parsePartnerSite(url, doc);
    // Stocker pour √©tape 2
    window.__eventData = {...data, sourceUrl:url};
    document.getElementById('previewData').textContent = JSON.stringify(window.__eventData, null, 2);
    document.getElementById('preview').style.display = 'block';
    document.getElementById('manualImport').style.display = 'none';
    showOk('Analyse manuelle termin√©e. V√©rifiez les donn√©es puis cliquez sur Publier.');
  }catch(err){
    showError('Erreur lors de l\'analyse manuelle: ' + err.message);
  }finally{
    setLoading(false);
  }
}

function toggleManualImport(){
  const manualDiv = document.getElementById('manualImport');
  manualDiv.style.display = manualDiv.style.display === 'none' ? 'block' : 'none';
}

/* =====================
 * √âtape 2: Publication Mondelibertin
 * ===================== */
async function publishToMondelibertin(){
  hideStatus();
  const data = window.__eventData;
  if(!data){showError('Aucune donn√©e √† publier.');return;}
  setLoading(true);
  try{
    // 1. R√©cup√©rer la page create pour obtenir le token CSRF
    const createGet = await fetch('https://mondelibertin.com/events/create', {credentials:'include'});
    if(!createGet.ok) throw new Error('Acc√®s √† /events/create refus√© ('+createGet.status+'). √ätes-vous connect√© ?');
    const createHtml = await createGet.text();
    const createDoc = new DOMParser().parseFromString(createHtml, 'text/html');
    // Vous devrez peut-√™tre adapter le s√©lecteur pour le token SocialEngine
    const csrfToken = createDoc.querySelector('input[name="token"]')?.value || createDoc.querySelector('input[name="csrf_token"]')?.value || '';
    if(!csrfToken) console.warn('Token CSRF introuvable, tentative sans.');

    // 2. Pr√©parer formulaire (adaptez les noms de champs √† SocialEngine-Events)
    const form = new URLSearchParams();
    form.append('token', csrfToken);
    form.append('title', data.title || 'Titre manquant');
    form.append('description', data.description || '');
    form.append('host_type', 0); // exemple de champ obligatoire SocialEngine
    form.append('starttime_date', data.startDate || '');
    form.append('endtime_date', data.endDate || '');
    form.append('location', data.location || '');
    form.append('category', data.category || '');
    form.append('source_url', data.sourceUrl);
    // TODO : upload d'image -> n√©cessite multipart/form-data.

    const publishRes = await fetch('https://mondelibertin.com/events/create', {
      method:'POST',
      credentials:'include',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:form.toString()
    });
    if(!publishRes.ok) throw new Error('Erreur lors de la publication ('+publishRes.status+').');

    showOk('Publication r√©ussie !');
  }catch(err){
    showError(err.message);
  }finally{
    setLoading(false);
  }
}

/* =====================
 * UI helpers
 * ===================== */
function setLoading(is){
  document.getElementById('btnParse').disabled = is;
  document.getElementById('btnPublish').disabled = is;
}
function showOk(msg){
  const el = document.getElementById('result');
  el.className='status ok';
  el.textContent=msg;
  el.style.display='block';
}
function showError(msg){
  const el = document.getElementById('result');
  el.className='status err';
  el.textContent=msg;
  el.style.display='block';
}
function hideStatus(){
  document.getElementById('result').style.display='none';
}

/* =====================
 * Event listeners
 * ===================== */
 document.getElementById('btnParse').addEventListener('click', parsePartnerPage);
 document.getElementById('btnPublish').addEventListener('click', publishToMondelibertin);
 document.getElementById('btnManual').addEventListener('click', toggleManualImport);
 document.getElementById('btnParseManual').addEventListener('click', parseManualHtml);
</script>
</body>
</html>